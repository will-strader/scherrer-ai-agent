<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Bid Assistant (MVP)</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; }
      .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
      .row { display: flex; gap: 12px; align-items: center; }
      button { padding: 10px 14px; border-radius: 10px; border: 1px solid #bbb; cursor: pointer; }
      pre { background: #f8f8f8; padding: 12px; border-radius: 10px; overflow: auto; }
      .links a { margin-right: 12px; }
      .spinner { display: none; width: 24px; height: 24px; border: 3px solid #ddd; border-top-color: #555; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .error { color: #b00020; background: #ffecec; padding: 8px 12px; border-radius: 10px; border: 1px solid #f4bdbd; margin-top: 8px; }
    </style>
  </head>
  <body>
    <h2>AI Bid Assistant (MVP)</h2>

    <div class="card">
      <form id="uploadForm">
        <div class="row">
          <input type="file" id="pdf" accept="application/pdf" required />
          <button type="submit">Upload & Process</button>
        </div>
      </form>
    </div>

    <div id="statusCard" class="card" style="display:none;">
      <div class="row">
        <div class="spinner" id="spinner" aria-label="Processing"></div>
        <div id="progressMsg" style="font-size: 14px; color: #555;">Waiting to start…</div>
      </div>
      <div id="errorBox" class="error" style="display:none;"></div>
      <div>Status: <span id="status">—</span></div>
      <div class="links" id="links"></div>
      <pre id="debug"></pre>
    </div>

    <script>
      // API key usage updated: now uses a global variable window.FRONTEND_ACCESS_TOKEN if available,
      // otherwise empty string. No prompt.
      const FRONTEND_ACCESS_TOKEN = window.FRONTEND_ACCESS_TOKEN || "";
      if (!FRONTEND_ACCESS_TOKEN) {
        console.warn("No frontend access token provided; proceeding without authentication.");
      }

      const API = location.hostname === "localhost" || location.hostname === "127.0.0.1"
        ? "http://127.0.0.1:8000"
        : "https://scherrer-ai-agent.onrender.com";

      const form = document.getElementById('uploadForm');
      const statusCard = document.getElementById('statusCard');
      const statusEl = document.getElementById('status');
      const linksEl = document.getElementById('links');
      const debugEl = document.getElementById('debug');
      const spinner = document.getElementById('spinner');
      const errorBox = document.getElementById('errorBox');
      const progressMsg = document.getElementById('progressMsg');
      const submitBtn = document.querySelector('button[type="submit"]');

      form.onsubmit = async (e) => {
        e.preventDefault();
        errorBox.style.display = 'none';
        errorBox.textContent = '';

        const file = document.getElementById('pdf').files[0];
        if (!file) return;

        // UI: show spinner and disable submit
        spinner.style.display = 'inline-block';
        progressMsg.textContent = 'Uploading PDF…';
        submitBtn.disabled = true;

        const fd = new FormData();
        fd.append('file', file);

        let headers = {};
        if (FRONTEND_ACCESS_TOKEN) {
          headers["x-frontend-token"] = FRONTEND_ACCESS_TOKEN;
        }

        let resp;
        try {
          resp = await fetch(`${API}/process`, { 
            method: 'POST', 
            body: fd,
            headers: headers
          });
        } catch (err) {
          spinner.style.display = 'none';
          submitBtn.disabled = false;
          errorBox.textContent = `Network error while starting the job: ${err}`;
          errorBox.style.display = 'block';
          return;
        }
        if (!resp.ok) {
          spinner.style.display = 'none';
          submitBtn.disabled = false;
          errorBox.textContent = `Failed to start job: ${resp.status} ${resp.statusText}`;
          errorBox.style.display = 'block';
          return;
        }

        const data = await resp.json();

        statusCard.style.display = 'block';
        statusEl.textContent = data.status || 'queued';
        linksEl.innerHTML = '';
        debugEl.textContent = '';
        progressMsg.textContent = 'Processing…';

        const jobId = data.job_id;
        const poll = setInterval(async () => {
          try {
            let pollHeaders = {};
            if (FRONTEND_ACCESS_TOKEN) {
              pollHeaders["x-frontend-token"] = FRONTEND_ACCESS_TOKEN;
            }
            const r = await fetch(`${API}/status/${jobId}`, {
              headers: pollHeaders
            });
            if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
            const s = await r.json();
            statusEl.textContent = s.status;

            if (s.status === 'done') {
              clearInterval(poll);
              spinner.style.display = 'none';
              submitBtn.disabled = false;
              progressMsg.textContent = s.message || 'Completed.';
              if (s.output_paths?.json) {
                try {
                  const j = await fetch(`${API}${s.output_paths.json}`, {
                    headers: pollHeaders
                  });
                  if (j.ok) {
                    const jdata = await j.json();
                    debugEl.textContent = JSON.stringify(jdata, null, 2);
                  }
                } catch {}
              }
              if (s.output_paths?.excel) {
                linksEl.innerHTML = `<a href="${API}${s.output_paths.excel}" download>Download Excel</a>`;
              }
            } else if (s.status === 'error') {
              clearInterval(poll);
              spinner.style.display = 'none';
              submitBtn.disabled = false;
              progressMsg.textContent = s.message || 'Error.';
              errorBox.textContent = s.message || 'An unknown error occurred during processing.';
              errorBox.style.display = 'block';
            } else {
              // queued | processing
              progressMsg.textContent = s.status + (s.message ? `: ${s.message}` : '');
            }
          } catch (err) {
            clearInterval(poll);
            spinner.style.display = 'none';
            submitBtn.disabled = false;
            progressMsg.textContent = 'Error.';
            errorBox.textContent = `Error fetching status: ${err}`;
            errorBox.style.display = 'block';
          }
        }, 1200);
      };
    </script>
  </body>
</html>